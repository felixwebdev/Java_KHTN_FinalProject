<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="author" content="Untree.co">
	<link rel="shortcut icon" href="favicon.png">

	<meta name="description" content="" />
	<meta name="keywords" content="bootstrap, bootstrap5" />

	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;600;700&display=swap" rel="stylesheet">


	<link rel="stylesheet" href="fonts/icomoon/style.css">
	<link rel="stylesheet" href="fonts/flaticon/font/flaticon.css">

	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">

	<link rel="stylesheet" href="css/tiny-slider.css">
	<link rel="stylesheet" href="css/aos.css">
	<link rel="stylesheet" href="css/glightbox.min.css">
	<link rel="stylesheet" href="css/style.css">

	<link rel="stylesheet" href="css/flatpickr.min.css">
	
	<link rel="stylesheet" href="css/subStyle.css">


	<title>Blogy &mdash; Free Bootstrap 5 Website Template by Untree.co</title>
</head>
<body>

	<div class="site-mobile-menu site-navbar-target">
		<div class="site-mobile-menu-header">
			<div class="site-mobile-menu-close">
				<span class="icofont-close js-menu-toggle"></span>
			</div>
		</div>
		<div class="site-mobile-menu-body"></div>
	</div>

	<nav class="site-nav">
		<div class="container">
			<div class="menu-bg-wrap">
				<div class="site-navigation">
					<div class="row g-0 align-items-center">
						<div class="col-2">
							<a href="index.html" class="logo m-0 float-start">Blogy<span class="text-primary">.</span></a>
						</div>
						<div class="col-8 text-center">
							<ul class="js-clone-nav d-none d-lg-inline-block text-start site-menu mx-auto">
								<li class="active"><a href="index.html">Home</a></li>
								<li><a href="blog.html">Blogs</a></li>
								<li><a href="contact.html">Contact Us</a></li>
								<li><a href="share.html">Share</a></li>
							</ul>
						</div>
						<div class="col-2 text-end nav-account">
							<div class="account-not-signedin">
								<div class="account-icon" id="openAuthModal">
									<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-person-add" viewBox="0 0 16 16">
									<path d="M12.5 16a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7m.5-5v1h1a.5.5 0 0 1 0 1h-1v1a.5.5 0 0 1-1 0v-1h-1a.5.5 0 0 1 0-1h1v-1a.5.5 0 0 1 1 0m-2-6a3 3 0 1 1-6 0 3 3 0 0 1 6 0M8 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4"/>
									<path d="M8.256 14a4.5 4.5 0 0 1-.229-1.004H3c.001-.246.154-.986.832-1.664C4.484 10.68 5.711 10 8 10q.39 0 .74.025c.226-.341.496-.65.804-.918Q8.844 9.002 8 9c-5 0-6 3-6 4s1 1 1 1z"/>
									</svg>
								</div>
							</div>

							<div class="account-signedin">
								<div class="account-icon">
									<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-person" viewBox="0 0 16 16">
									<path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6m2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0m4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4m-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10s-3.516.68-4.168 1.332c-.678.678-.83 1.418-.832 1.664z"/>
									</svg>
								</div>
								<ul class="account-dropdown">
									<li><a href="#">Profile</a></li>
									<li><a href="myBlogs.html">My Blogs</a></li>
									<li id="btn-signOut"><a href="#">Sign out</a></li>
								</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
	</nav>

	<!-- Modal đăng nhập/đăng ký -->
	<div id="authModal" class="auth-modal">
		<div class="auth-modal-content">

			<span class="auth-close" id="closeAuthModal">&times;</span>

			<h2 class="auth-title" id="authTitle">Sign In</h2>

			<!-- Form đăng nhập -->
			<form id="signinForm" class="auth-form active">
				<input type="email" placeholder="Email" required />
				<input type="password" placeholder="Password" required />
				<button type="submit" class="auth-btn">Sign In</button>

				<p class="switch-text">
					Don't have an account?
					<a href="#" id="toSignup">Sign Up</a>
				</p>
			</form>

			<!-- Form đăng ký -->
			<form id="signupForm" class="auth-form">
				<input type="email" placeholder="Email" required />
				<input type="password" placeholder="Password" required />
				<input type="text" placeholder="Full Name" required />
				<input type="date" name="" id="" required/>
				<button type="submit" class="auth-btn">Sign Up</button>

				<p class="switch-text">
					Already have an account?
					<a href="#" id="toSignin">Sign In</a>
				</p>
			</form>

		</div>
	</div>

	<!-- MANAGE POSTS SECTION -->
    <section class="site-section" id="managePosts" style="padding: 40px 0;">
        <div class="container">
            <div class="row justify-content-center mb-3">
                <div class="col-lg-10 d-flex align-items-center justify-content-between">
                    <h2 class="mb-0">Your Blogs</h2>
                    <button id="btn-refresh-posts" class="btn btn-outline-secondary">Refresh</button>
                </div>
            </div>

            <div id="postsList" class="row g-3">
                <!-- Posts will be rendered here -->
            </div>

            <!-- Pagination UI -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div id="postsInfo" class="text-muted small">--</div>
                <div class="d-flex align-items-center gap-2">
                  <label class="small mb-0 me-1">Per page</label>
                  <select id="perPageSelect" class="form-select form-select-sm" style="width:85px;">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="20">20</option>
                  </select>
                  <nav><ul class="pagination mb-0" id="postsPagination"></ul></nav>
                </div>
            </div>

            <div id="noPosts" class="text-center text-muted" style="display:none">
                You have no posts yet.
            </div>
        </div>
    </section>

    <!-- Edit Post Modal -->
    <div class="modal fade" id="editPostModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <form id="editPostForm" enctype="multipart/form-data">
            <div class="modal-header">
              <h5 class="modal-title">Edit Post</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" id="editPostId" />
              <div class="mb-3">
                <label class="form-label">Title</label>
                <input id="editTitle" class="form-control" required />
              </div>
              <div class="mb-3">
                <label class="form-label">Short description</label>
                <input id="editDescription" class="form-control" />
              </div>
              <div class="mb-3">
                <label class="form-label">Content</label>
                <textarea id="editContent" class="form-control" rows="6"></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Location</label>
                <input id="editLocation" class="form-control" />
              </div>
              <div class="mb-3">
                <label class="form-label">Image</label>
                <div class="d-flex align-items-center gap-3">
                  <img id="editImagePreview" src="" alt="preview" style="width:120px; height:80px; object-fit:cover; display:none; border-radius:6px;" />
                  <input id="editImageFile" type="file" accept="image/*" class="form-control w-auto" />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Visibility</label>
                <select id="editStatus" class="form-select">
                  <option value="true">Published</option>
                  <option value="false">Private</option>
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Save changes</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <style>
      /* small styling for posts list */
      .post-card .post-actions .btn { min-width: 70px; }
      .post-thumb { width: 140px; height: 90px; object-fit: cover; border-radius:6px; }
    </style>
	

	<footer class="site-footer">
		<div class="container">
			<div class="row">
				<div class="col-lg-4">
					<div class="widget">
						<h3 class="mb-4">About</h3>
						<p>Far far away, behind the word mountains, far from the countries Vokalia and Consonantia, there live the blind texts.</p>
					</div> <!-- /.widget -->
					<div class="widget">
						<h3>Social</h3>
						<ul class="list-unstyled social">
							<li><a href="#"><span class="icon-instagram"></span></a></li>
							<li><a href="#"><span class="icon-twitter"></span></a></li>
							<li><a href="#"><span class="icon-facebook"></span></a></li>
							<li><a href="#"><span class="icon-linkedin"></span></a></li>
							<li><a href="#"><span class="icon-pinterest"></span></a></li>
							<li><a href="#"><span class="icon-dribbble"></span></a></li>
						</ul>
					</div> <!-- /.widget -->
				</div> <!-- /.col-lg-4 -->
				<div class="col-lg-4 ps-lg-5">
					<div class="widget">
						<h3 class="mb-4">Company</h3>
						<ul class="list-unstyled float-start links">
							<li><a href="#">About us</a></li>
							<li><a href="#">Services</a></li>
							<li><a href="#">Vision</a></li>
							<li><a href="#">Mission</a></li>
							<li><a href="#">Terms</a></li>
							<li><a href="#">Privacy</a></li>
						</ul>
						<ul class="list-unstyled float-start links">
							<li><a href="#">Partners</a></li>
							<li><a href="#">Business</a></li>
							<li><a href="#">Careers</a></li>
							<li><a href="#">Blog</a></li>
							<li><a href="#">FAQ</a></li>
							<li><a href="#">Creative</a></li>
						</ul>
					</div> <!-- /.widget -->
				</div> <!-- /.col-lg-4 -->
				<div class="col-lg-4">
					<div class="widget">
						<h3 class="mb-4">Recent Post Entry</h3>
						<div class="post-entry-footer">
							<ul>
								<li>
									<a href="">
										<img src="images/img_1_sq.jpg" alt="Image placeholder" class="me-4 rounded">
										<div class="text">
											<h4>There’s a Cool New Way for Men to Wear Socks and Sandals</h4>
											<div class="post-meta">
												<span class="mr-2">March 15, 2018 </span>
											</div>
										</div>
									</a>
								</li>
								<li>
									<a href="">
										<img src="images/img_2_sq.jpg" alt="Image placeholder" class="me-4 rounded">
										<div class="text">
											<h4>There’s a Cool New Way for Men to Wear Socks and Sandals</h4>
											<div class="post-meta">
												<span class="mr-2">March 15, 2018 </span>
											</div>
										</div>
									</a>
								</li>
								<li>
									<a href="">
										<img src="images/img_3_sq.jpg" alt="Image placeholder" class="me-4 rounded">
										<div class="text">
											<h4>There’s a Cool New Way for Men to Wear Socks and Sandals</h4>
											<div class="post-meta">
												<span class="mr-2">March 15, 2018 </span>
											</div>
										</div>
									</a>
								</li>
							</ul>
						</div>


					</div> <!-- /.widget -->
				</div> <!-- /.col-lg-4 -->
			</div> <!-- /.row -->

			<div class="row mt-5">
				<div class="col-12 text-center">
          <!-- 
              **==========
              NOTE: 
              Please don't remove this copyright link unless you buy the license here https://untree.co/license/  
              **==========
            -->

            <p>Copyright &copy;<script>document.write(new Date().getFullYear());</script>. All Rights Reserved. &mdash; Designed with love by <a href="https://untree.co">Untree.co</a>  Distributed by <a href="https://themewagon.com">ThemeWagon</a> <!-- License information: https://untree.co/license/ -->
            </p>
          </div>
        </div>
      </div> <!-- /.container -->
    </footer> <!-- /.site-footer -->

    <!-- Preloader -->
    <div id="overlayer"></div>
    <div class="loader">
    	<div class="spinner-border text-primary" role="status">
    		<span class="visually-hidden">Loading...</span>
    	</div>
    </div>


    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/tiny-slider.js"></script>

    <script src="js/flatpickr.min.js"></script>


    <script src="js/aos.js"></script>
    <script src="js/glightbox.min.js"></script>
    <script src="js/navbar.js"></script>
    <script src="js/counter.js"></script>
    <script src="js/custom.js"></script>

	<script src="js/accounts.js"></script>

     <script>
      (function () {
        const API_BASE = 'http://localhost:8080/api';
        const token = localStorage.getItem('token');
        const postsListEl = document.getElementById('postsList');
        const noPostsEl = document.getElementById('noPosts');
        const refreshBtn = document.getElementById('btn-refresh-posts');
        const postsInfo = document.getElementById('postsInfo');
        const postsPagination = document.getElementById('postsPagination');
        const perPageSelect = document.getElementById('perPageSelect');

        // pagination state
        let currentPage = 0;
        let totalPages = 1;
        let totalItems = 0;
        let limit = parseInt(perPageSelect.value || '10', 10);

        // modal elements
        const editModalEl = new bootstrap.Modal(document.getElementById('editPostModal'));
        const editForm = document.getElementById('editPostForm');
        const editPostId = document.getElementById('editPostId');
        const editTitle = document.getElementById('editTitle');
        const editDescription = document.getElementById('editDescription');
        const editContent = document.getElementById('editContent');
        const editLocation = document.getElementById('editLocation');
        const editStatus = document.getElementById('editStatus');
        const editImagePreview = document.getElementById('editImagePreview');
        const editImageFile = document.getElementById('editImageFile');
        const removeImageBtn = document.getElementById('removeImageBtn');

        // events
        refreshBtn.addEventListener('click', () => loadPosts(currentPage));
        perPageSelect.addEventListener('change', () => {
          limit = parseInt(perPageSelect.value, 10);
          currentPage = 0;
          loadPosts(currentPage);
        });

        async function loadPosts(page = 0) {
          postsListEl.innerHTML = '';
          noPostsEl.style.display = 'none';
          postsPagination.innerHTML = '';
          postsInfo.textContent = 'Loading...';

          try {
            const resp = await fetch(`${API_BASE}/blog?page=${page}&size=${limit}&sort=createdDate,desc`, {
              headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!resp.ok) throw new Error('Failed to load posts');
            const res = await resp.json();
            const data = res.content;
            console.lo
            // normalize posts array
            let posts;
            if (Array.isArray(data)) posts = data;
            else if (Array.isArray(data.items)) posts = data.items;
            else if (Array.isArray(data.content)) posts = data.content;
            else if (Array.isArray(data.data)) posts = data.data;
            else if (Array.isArray(data.posts)) posts = data.posts;
            else if (Array.isArray(data.docs)) posts = data.docs;
            else if (data && (data._id || data.id)) posts = [data];
            else posts = [];

            // parse pagination info
            // different backend shapes: { total, page, limit, totalPages } or { totalItems, page, pageSize } or Spring-style { content, totalPages, number, size }
            const metaTotal = data.total ?? data.totalItems ?? data.totalDocs ?? data.count ?? (Array.isArray(data.items) ? (data.items.length) : null);
            const metaPage = data.page ?? data.currentPage ?? data.number ?? page;
            const metaLimit = data.limit ?? data.pageSize ?? data.size ?? limit;
            const metaTotalPages = data.totalPages ?? data.pages ?? (metaTotal && metaLimit ? Math.ceil(metaTotal / metaLimit) : null);

            totalItems = metaTotal ?? res.totalElements;
            currentPage = Number(metaPage ?? page);
            totalPages = res.totalPages-1;

            console.log({ totalItems, currentPage, totalPages });

            if (!posts || posts.length === 0) {
              noPostsEl.style.display = 'block';
              postsInfo.textContent = `No posts`;
              return;
            }

            posts.forEach(p => renderPostCard(p));
            renderPagination();
            updatePostsInfo();
          } catch (err) {
            console.error(err);
            noPostsEl.textContent = 'Không thể tải bài viết';
            noPostsEl.style.display = 'block';
            postsInfo.textContent = '';
          }
        }

        function updatePostsInfo() {
          const start = currentPage  * limit + 1;
          const end = Math.min(totalItems, currentPage * limit + limit);
          postsInfo.textContent = `Showing ${start}-${end} of ${totalItems}`;
        }

        function renderPagination() {
          postsPagination.innerHTML = '';
          if (totalPages <= 0) return;

          const createPageItem = (label, page, disabled = false, active = false) => {
            const li = document.createElement('li');
            li.className = `page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${page}">${label}</a>`;
            li.querySelector('a').addEventListener('click', (e) => {
              e.preventDefault();
              if (disabled || active) return;
              loadPosts(page);
            });
            return li;
          };


          postsPagination.appendChild(createPageItem('Prev', Math.max(1, currentPage - 1), currentPage === 1));

          const maxButtons = 7;
          let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
          let endPage = startPage + maxButtons - 1;
          if (endPage > totalPages) {
            endPage = totalPages;
            startPage = Math.max(1, endPage - maxButtons + 1);
          }

          if (startPage > 0) {
            postsPagination.appendChild(createPageItem('0', 0, false, currentPage === 0));
            if (startPage > 1) {
              const li = document.createElement('li');
              li.className = 'page-item disabled';
              li.innerHTML = `<span class="page-link">…</span>`;
              postsPagination.appendChild(li);
            }
          }

          for (let p = startPage; p <= endPage; p++) {
            postsPagination.appendChild(createPageItem(p, p, false, p === currentPage));
          }

          if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
              const li = document.createElement('li');
              li.className = 'page-item disabled';
              li.innerHTML = `<span class="page-link">…</span>`;
              postsPagination.appendChild(li);
            }
            postsPagination.appendChild(createPageItem(totalPages, totalPages, false, currentPage === totalPages));
          }

          // Next
          postsPagination.appendChild(createPageItem('Next', Math.min(totalPages, currentPage + 1), currentPage === totalPages));
        }

        // render, open edit modal etc.
        function renderPostCard(post) {
          const col = document.createElement('div');
          col.className = 'col-12';

          const card = document.createElement('div');
          card.className = 'card post-card shadow-sm p-2';
          card.dataset.id = post._id || post.id;

          card.innerHTML = `
            <div class="row g-2 align-items-center">
              <div class="col-md-2">
                <img src="${post.img || 'images/img_1_sq.jpg'}" class="post-thumb" alt="thumb">
              </div>
              <div class="col-md-7">
                <h5 class="mb-1">${escapeHtml(post.title)}</h5>
                <p class="mb-1 text-muted small">${escapeHtml(post.shortDescription || (post.content || '').slice(0,120))}</p>
                <div class="small text-muted">${post.createdAt ? new Date(post.createdAt).toLocaleString() : ''}</div>
              </div>
              <div class="col-md-3 text-end post-actions">
                <div class="d-flex justify-content-end gap-2">
                  <button class="btn btn-sm btn-outline-primary btn-edit">Edit</button>
                  <button class="btn btn-sm btn-outline-danger btn-delete">Delete</button>
                </div>
                <div class="mt-2">
                  <select class="form-select form-select-sm status-select">
                    <option value="true"  ${post.isPublic ? 'selected' : ''}>Published</option>
                    <option value="false" ${!post.isPublic ? 'selected' : ''}>Private</option>
                </select>
                </div>
              </div>
            </div>
          `;

          // set initial select value
          const statusSelect = card.querySelector('.status-select');
          statusSelect.value = String(Boolean(post.isPublic));

          // button handlers
          card.querySelector('.btn-edit').addEventListener('click', () => openEditModal(post._id || post.id));
          card.querySelector('.btn-delete').addEventListener('click', () => deletePost(post._id || post.id, card));
         statusSelect.addEventListener('change', (e) => updateStatus(post._id || post.id, e.target.value === 'true'));

          col.appendChild(card);
          postsListEl.appendChild(col);
        }

        async function openEditModal(id) {
          try {
            const resp = await fetch(`${API_BASE}/blog/${id}`, {
              headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!resp.ok) throw new Error('Cannot fetch post');
            const json = await resp.json();
            const p = json.data || json;
            editPostId.value = id;
            editTitle.value = p.title || '';
            editDescription.value = p.shortDescription || '';
            editContent.value = p.content || '';
            editLocation.value = p.location || '';
            editStatus.value = p.isPublic || 'published';
            if (p.img) {
              editImagePreview.src = p.img;
              editImagePreview.style.display = 'block';
            } else {
              editImagePreview.style.display = 'none';
              editImagePreview.src = '';
            }
            editImageFile.value = '';
            editImageFile.dataset.remove = '0';
            editModalEl.show();
          } catch (err) {
            console.error(err);
            alert('Không tải được thông tin bài viết');
          }
        }

        editImageFile.addEventListener('change', () => {
          const f = editImageFile.files[0];
          if (f) {
            editImagePreview.src = URL.createObjectURL(f);
            editImagePreview.style.display = 'block';
            removeImageBtn.style.display = 'inline-block';
          }
        });

        removeImageBtn.addEventListener('click', () => {
          editImagePreview.src = '';
          editImagePreview.style.display = 'none';
          removeImageBtn.style.display = 'none';
          editImageFile.value = '';
          editImageFile.dataset.remove = '1';
        });

        editForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const id = editPostId.value;
          const formData = new FormData();
          formData.append('title', editTitle.value);
          formData.append('shortDes', editDescription.value);
          formData.append('content', editContent.value);
          formData.append('location', editLocation.value);
          formData.append('isPublic', editStatus.value);
          const file = editImageFile.files[0];
          if (file) formData.append('file', file);

          try {
            const resp = await fetch(`${API_BASE}/blog/${id}`, {
              method: 'PUT',
              headers: { 'Authorization': 'Bearer ' + token },
              body: formData
            });
            if (!resp.ok) {
              const text = await resp.text();
              throw new Error(text || 'Update failed');
            }
            editModalEl.hide();
            await loadPosts(currentPage);
          } catch (err) {
            console.error(err);
            alert('Cập nhật thất bại: ' + (err.message || ''));
          }
        });

        async function deletePost(id, cardEl) {
          if (!confirm('Bạn có chắc chắn muốn xóa bài viết này?')) return;
          try {
            const resp = await fetch(`${API_BASE}/blog/${id}`, {
              method: 'DELETE',
              headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!resp.ok) throw new Error('Delete failed');
            // reload current page to update counts
            await loadPosts(currentPage);
          } catch (err) {
            console.error(err);
            alert('Xóa thất bại');
          }
        }

        async function updateStatus(id, newIsPublic) {
            try {
                const resp = await fetch(`${API_BASE}/blog/status`, {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    id: id,
                    status: newIsPublic 
                })
                });
                if (!resp.ok) throw new Error('Update status failed');
                await loadPosts(currentPage);
            } catch (err) {
                console.error(err);
                alert('Chưa cập nhật trạng thái, thử lại');
                loadPosts(currentPage);
            }
        }

        // simple escape
        function escapeHtml(unsafe) {
          if (!unsafe) return '';
          return unsafe.replace(/[&<"'>]/g, function (m) {
            return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' })[m];
          });
        }

        // initial load
        loadPosts(currentPage);

      })();
    </script>
  </body>
  </html>
